<!DOCTYPE html>
<html lang="de-de">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="CAFfeZeit">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="http://localhost:1313//">
    <meta property="twitter:image" content="http://localhost:1313//" />
    

    
    <meta name="title" content="Cost Management - Azure RI vs. Saving Plans" />
    <meta property="og:title" content="Cost Management - Azure RI vs. Saving Plans" />
    <meta property="twitter:title" content="Cost Management - Azure RI vs. Saving Plans" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Cost Management - Azure RI vs. Saving Plans | </title>

    <link rel="canonical" href="/posts/caf-govern-cost.de/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link rel="stylesheet" href="/css/font-awesome.all.min.css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>






<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">CAFfeZeit</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                    
                    
		    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>



<header class="intro-header" style="background-image: url('/')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 ">
                <div class="site-heading">
                    <h1>CAFfeZeit </h1>
                    
		    <span class="subheading"></span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">
            
            <div class="
            col-lg-8 col-lg-offset-1
            col-md-8 col-md-offset-1
            col-sm-12
            col-xs-12
            post-container">
            
                <p>Immer wieder gibt es die Diskussion sind die Azure Reserved Instances (RI) oder der Azure Saving Plan (SP) die bessere Option für den Betrieb einer Applikation auf Basis von IaaS in Azure. Es gibt nicht die eine Antwort auf diese Frage. Im folgenden werden die beiden Optionen Reserved Instance und Saving Plan gegen übergestellt und anhand von Szenarien bewertet.</p>
<p>Kurze Begriffsklärung:</p>
<h2 id="azure-reserved-instance">Azure Reserved Instance</h2>
<p>Bei einer Reserved Instance handelt es sich im ein Commitment für einer Bestimmte VM in einer bestimmten Region für eine bestimmte Zeit. Also z.B. eine D8s_v5 VM in Westeuropa für drei Jahre. Diese Reservierung kann dann monatlich über 3 Jahre gezahlt werden und bietet ein Rabat von bis zu 72%. In diesem konkreten Beispiel liegt der Preisvorteil bei ~62% Rabatt. Wichtig dabei ist, die Reservierung muss bezahlt werden, egal ob Sie genutzt wird oder nicht. Auf MS Learn findet mal unter folgendem Link eine detaillierte Dokumentation zu dem Thema: <a href="https://learn.microsoft.com/azure/virtual-machines/prepay-reserved-vm-instances">Kostensparen mit reservierten Azure-VM-Instanzen</a></p>
<h2 id="azure-saving-plan">Azure Saving Plan</h2>
<p>Bei einem Savin Plan wird im Gegensatz zu einer Reserved Instance nicht eine konkrete VM in einer konkreten Region reserviert, sondern nur eine Summe EUR an Compute. Dies kann dann flexibel für unterschiedliche VMs oder auch andere Compute Services genutzt werden. Die reservierte Summe wird dann monatlich abgerechnet, egal ob Sie vollständig genutzt wurde oder nicht. Sollte man mehr verbrauchen, als man committet hat, wird zum Pay-as-you-go Preis abgerechnet. Zu den Saving Plans ist die Dokumentation an folgender Stelle: <a href="https://learn.microsoft.com/de-de/azure/cost-management-billing/savings-plan/savings-plan-compute-overview">Was sind Azure-Sparpläne für Compute?</a></p>
<h2 id="szenarios">Szenarios</h2>
<p>Um eine mögliche gute Vergleichbarkeit zu bekommen, gehen wir von folgenden Szenarien aus und bewerten die Kosten der jeweiligen Lösung. Stellen wir uns vor wir haben ein Zeiterfassungssystem. Dieses System wird primär in den Zeiten zwischen 6:00 Uhr und 18:00 Uhr benötigt.</p>
<ul>
<li><strong>Szenario A:</strong> Der Workload läuft 12 Stunden am Tag und könnte theoretisch komplett abgeschaltet werden in den anderen 12 Stunden</li>
<li><strong>Szenario B:</strong> Der Workload läuft 12 Stunden am Tag, muss aber in den anderen 12 Stunden weiterhin verfügbar sein, gern aber mit weniger Leistung.</li>
<li><strong>Szenario C:</strong> Der Workload läuft nur 21 Werktage 12 Stunden und könnte in der restlichen Zeit durch eine leistungsschwächere VM ersetzt werden.</li>
</ul>
<table>
  <thead>
      <tr>
          <th>Annahme</th>
          <th style="text-align: right">Wert</th>
          <th>Einheit</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Kalkulatorische Stunden pro Monat</td>
          <td style="text-align: right">730</td>
          <td>Stunden</td>
      </tr>
      <tr>
          <td>30 Tage 6:00 - 18:00 Uhr</td>
          <td style="text-align: right">360</td>
          <td>Stunden</td>
      </tr>
      <tr>
          <td>21 Arbeitstage 6:00 - 18:00 Uhr</td>
          <td style="text-align: right">252</td>
          <td>Stunden</td>
      </tr>
  </tbody>
</table>
<p>Als Basis für die VM-Preise wurden die Daten aus dem Azure Preiskalkulator genommen (Region &ldquo;westeurope&rdquo;):</p>
<table>
  <thead>
      <tr>
          <th>VM Type</th>
          <th style="text-align: right">Pay-as-you-go (PAYG)</th>
          <th style="text-align: right">RI</th>
          <th style="text-align: right">SP</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>D8s_v5</td>
          <td style="text-align: right">0,438 EUR/h</td>
          <td style="text-align: right">0,166 EUR/h</td>
          <td style="text-align: right">0,240 EUR/h</td>
      </tr>
      <tr>
          <td>D4s_v5</td>
          <td style="text-align: right">0,213 EUR/h</td>
          <td style="text-align: right">0,083 EUR/h</td>
          <td style="text-align: right">0,0120 EUR/h</td>
      </tr>
      <tr>
          <td>B4s_v2</td>
          <td style="text-align: right">0,183 EUR/h</td>
          <td style="text-align: right">0,069 EUR/h</td>
          <td style="text-align: right">0,097 EUR/h</td>
      </tr>
  </tbody>
</table>
<p>Alle Preise sind nur der Compute-Preis, also ohne Betriebssystemkosten. Preisrechner vom 10/05/2023.</p>
<h3 id="szenario-a">Szenario A</h3>
<p>Wenn das Zeiterfassungssystem wirklich komplett ausgeschaltet werden könnte in den Zeiten, wo es nicht genutzt wird, ergeben sich folgende Preise in einem Monat für die VM:</p>
<table>
  <thead>
      <tr>
          <th>Konstellation</th>
          <th style="text-align: right">Preis</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>VM D8s_v5 als RI</td>
          <td style="text-align: right">121,18 EUR/Monat</td>
      </tr>
      <tr>
          <td>VM D8s_v5 30 Tage 12 Stunden/Tag (PAYG)</td>
          <td style="text-align: right">157,68 EUR/Monat</td>
      </tr>
      <tr>
          <td>VM D8s_v5 21 Tage 12 Stunden/Tag (PAYG)</td>
          <td style="text-align: right">110,38 EUR/Monat</td>
      </tr>
  </tbody>
</table>
<p>Damit wird klar, dass es sich nur dann lohnen würde, den Pay-as-you-go Preis zu nehmen, wenn wir in den Bereich von 21 Tagen 12h am Tag kommen. Der RI-Rabatt von 62% auf den Pay-as-you-go Preis der VM zahlt sich ab ~350 Stunden Betriebszeit der VM aus.</p>
<h3 id="szenario-b">Szenario B</h3>
<p>Der Workload läuft 12 Stunden am Tag, muss aber in den anderen 12 Stunden weiterhin verfügbar sein, gern aber mit weniger Leistung.</p>
<p>Wenn alles im PAYG-Preis abgebildet wird und 12 Stunde eine D8s_v5 und 12 Stunden eine D4s_v5 genutzt werden:</p>
<table>
  <thead>
      <tr>
          <th>VM-Größe</th>
          <th style="text-align: right">Preis</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>D8s_v5</td>
          <td style="text-align: right">157,68 EUR/Monat</td>
      </tr>
      <tr>
          <td>D4s_v5</td>
          <td style="text-align: right">81,03 EUR/Monat</td>
      </tr>
      <tr>
          <td>Summe Workload</td>
          <td style="text-align: right">238,71 EUR/Monat</td>
      </tr>
      <tr>
          <td>Differenz zur RI</td>
          <td style="text-align: right">+ 97%</td>
      </tr>
  </tbody>
</table>
<p>Wenn alle Preise über einen <strong>Saving Plan</strong> abgedeckt werden:</p>
<table>
  <thead>
      <tr>
          <th>VM-Größe</th>
          <th style="text-align: right">Preis</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>D8s_v5</td>
          <td style="text-align: right">86,40 EUR/Monat</td>
      </tr>
      <tr>
          <td>D4s_v5</td>
          <td style="text-align: right">44,40 EUR/Monat</td>
      </tr>
      <tr>
          <td>Summe Workload</td>
          <td style="text-align: right">130,80 EUR/Monat</td>
      </tr>
      <tr>
          <td>Differenz zur RI</td>
          <td style="text-align: right">+ 8%</td>
      </tr>
  </tbody>
</table>
<p>Wenn alle Preise über einen <strong>Saving Plan</strong> abgedeckt werden und als Downsizing VM kann eine B-Series verwendet werden:</p>
<table>
  <thead>
      <tr>
          <th>VM Größe</th>
          <th style="text-align: right">Preis</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>D8s_v5</td>
          <td style="text-align: right">86,40 EUR/Monat</td>
      </tr>
      <tr>
          <td>B4s_v2</td>
          <td style="text-align: right">35,89 EUR/Monat</td>
      </tr>
      <tr>
          <td>Summe Workload</td>
          <td style="text-align: right">122,29 EUR/Monat</td>
      </tr>
      <tr>
          <td>Differenz zur RI</td>
          <td style="text-align: right">+ 0,92%</td>
      </tr>
  </tbody>
</table>
<p>Damit sind wir schon fast auf dem Preis einer RI.</p>
<h3 id="szenario-c">Szenario C</h3>
<p>Der Workload läuft nur 21 Werktage 12 Stunden und könnte in der restlichen Zeit durch eine leistungsschwächere VM ersetzt werden.</p>
<p>Wenn alles im PAYG-Preis abgebildet wird und 21 Arbeitstage für 12 Stunde eine D8s_v5 genutzt wird. In den restlichen Stunden wird dann auf eine D4s_v5 verändert:</p>
<table>
  <thead>
      <tr>
          <th>VM-Größe</th>
          <th style="text-align: right">Preis</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>D8s_v5</td>
          <td style="text-align: right">110,37 EUR/Monat</td>
      </tr>
      <tr>
          <td>D4s_v5</td>
          <td style="text-align: right">104,68 EUR/Monat</td>
      </tr>
      <tr>
          <td>Summe Workload</td>
          <td style="text-align: right">215,05 EUR/Monat</td>
      </tr>
      <tr>
          <td>Differenz zur RI</td>
          <td style="text-align: right">+ 77%</td>
      </tr>
  </tbody>
</table>
<p>Wenn alle Preise über einen <strong>Saving Plan</strong> abgedeckt werden:</p>
<table>
  <thead>
      <tr>
          <th>VM-Größe</th>
          <th style="text-align: right">Preis</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>D8s_v5</td>
          <td style="text-align: right">60,48 EUR/Monat</td>
      </tr>
      <tr>
          <td>D4s_v5</td>
          <td style="text-align: right">57,36 EUR/Monat</td>
      </tr>
      <tr>
          <td>Summe Workload</td>
          <td style="text-align: right">117,84 EUR/Monat</td>
      </tr>
      <tr>
          <td>Differenz zur RI</td>
          <td style="text-align: right"><strong>- 2,8%</strong></td>
      </tr>
  </tbody>
</table>
<p>Dann noch erweitert um eine B-Serie VM anstatt der D4s_v5 im <strong>Saving Plan</strong>:</p>
<table>
  <thead>
      <tr>
          <th>VM-Größe</th>
          <th style="text-align: right">Preis</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>D8s_v5</td>
          <td style="text-align: right">60,48 EUR/Monat</td>
      </tr>
      <tr>
          <td>B4s_v2</td>
          <td style="text-align: right">46,37 EUR/Monat</td>
      </tr>
      <tr>
          <td>Summe Workload</td>
          <td style="text-align: right">106,85 EUR/Monat</td>
      </tr>
      <tr>
          <td>Differenz zur RI</td>
          <td style="text-align: right"><strong>- 11,8%</strong></td>
      </tr>
  </tbody>
</table>
<p>Die letzten beiden Konstellationen erzeugen eine Ersparnis gegenüber der reinen RI für eine VM Größe.</p>
<p>Wenn man die Betrachtung nicht nur mit dem reinen Compute macht, sondern auch die Windows Lizenzen mit einkalkuliert verändert sich das Bild deutlich. Dann wird schon PAYG 30 Tage 12 Stunden in Benutzung ansonsten aus mit der gleichen VM-Größe günstiger als eine RI der gleichen VM Größe.</p>
<table>
  <thead>
      <tr>
          <th>Konstellation</th>
          <th style="text-align: right">Hochrechnung</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>RI D8s_v5</td>
          <td style="text-align: right">376,68 EUR/Monat</td>
      </tr>
      <tr>
          <td>PAYG 30 Tage 12 Stunden</td>
          <td style="text-align: right">291,56 EUR/Monat</td>
      </tr>
      <tr>
          <td>PAYG 21 Tage 12 Stunden</td>
          <td style="text-align: right">198,58 EUR/Monat</td>
      </tr>
  </tbody>
</table>
<p>Inkl. Betriebssystem und ausgeschaltet, wenn nicht benötigt.</p>
<table>
  <thead>
      <tr>
          <th>Konstellation</th>
          <th style="text-align: right">Szenario B</th>
          <th style="text-align: right">Szenario C</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>D8s_v5 + D4s_v5 PAYG</td>
          <td style="text-align: right">429,46 EUR/Monat</td>
          <td style="text-align: right">386,91 EUR/Monat</td>
      </tr>
      <tr>
          <td>D8s_v5 + D4s_v5 SP</td>
          <td style="text-align: right"><strong>321,55 EUR/Monat</strong></td>
          <td style="text-align: right"><strong>289,69 EUR/Monat</strong></td>
      </tr>
      <tr>
          <td>D8s_v5 + B4s_v2 SP</td>
          <td style="text-align: right"><strong>253,84 EUR/Monat</strong></td>
          <td style="text-align: right"><strong>202,22 EUR/Monat</strong></td>
      </tr>
  </tbody>
</table>
<p>In der Spitze erreicht man eine Ersparnis von über <strong>46% gegenüber der Rerserved Instance</strong>. Hier spielt der Vorteil im Preis für das OS bei einer B-Series VM die entscheidende Rolle.</p>
<h2 id="umsetzung">Umsetzung</h2>
<p>Um dies auch mal praktisch umzusetzen ist hier ein kurzes Beispiel der Umsetzung.</p>
<h3 id="deployment-einer-vm">Deployment einer VM</h3>
<p>Der bicep-Code um eine VM bereitzustellen kann <a href="https://caffezeit.org/download/deployvm.bicep">hier</a> heruntergeladen werden oder direkt hier kopiert werden:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>@description(<span style="color:#e6db74">&#39;Location to deploy the vNet and the VM&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> location string = <span style="color:#e6db74">&#39;westeurope&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@description(<span style="color:#e6db74">&#39;Name of the VM&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> vmName string = <span style="color:#e6db74">&#39;vm-sizingdemo01&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@description(<span style="color:#e6db74">&#39;Admin username for the VM&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> adminUsername string = <span style="color:#e6db74">&#39;demouser&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@description(<span style="color:#e6db74">&#39;Admin password for the VM&#39;</span>)
</span></span><span style="display:flex;"><span>@secure() 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> adminPassword string = <span style="color:#e6db74">&#39;Pass!word123&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@description(<span style="color:#e6db74">&#39;Name of the vNet&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> vnetName string = <span style="color:#e6db74">&#39;vnet-sizingdemo&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@description(<span style="color:#e6db74">&#39;Name of the subnet&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> subnetName string = <span style="color:#e6db74">&#39;snet-sizingdemo&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@description(<span style="color:#e6db74">&#39;Name of the automation account&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> automationAccountName string = <span style="color:#e6db74">&#39;aa-sizingdemo&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource vnet <span style="color:#e6db74">&#39;Microsoft.Network/virtualNetworks@2020-11-01&#39;</span> = {
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> vnetName
</span></span><span style="display:flex;"><span>  location<span style="color:#960050;background-color:#1e0010">:</span> location
</span></span><span style="display:flex;"><span>  properties<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>    addressSpace<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>      addressPrefixes<span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;10.0.0.0/16&#39;</span>
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    subnets<span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        name<span style="color:#960050;background-color:#1e0010">:</span> subnetName
</span></span><span style="display:flex;"><span>        properties<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>          addressPrefix<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;10.0.0.0/24&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource publicIp <span style="color:#e6db74">&#39;Microsoft.Network/publicIPAddresses@2020-11-01&#39;</span> = {
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;${vmName}-pip&#39;</span>
</span></span><span style="display:flex;"><span>  location<span style="color:#960050;background-color:#1e0010">:</span> location
</span></span><span style="display:flex;"><span>  properties<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>    publicIPAllocationMethod<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;Dynamic&#39;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource nic <span style="color:#e6db74">&#39;Microsoft.Network/networkInterfaces@2020-11-01&#39;</span> = {
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;${vmName}-nic&#39;</span>
</span></span><span style="display:flex;"><span>  location<span style="color:#960050;background-color:#1e0010">:</span> location
</span></span><span style="display:flex;"><span>  properties<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>    ipConfigurations<span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;ipconfig&#39;</span>
</span></span><span style="display:flex;"><span>        properties<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>          subnet<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            id<span style="color:#960050;background-color:#1e0010">:</span> vnet.properties.subnets[<span style="color:#ae81ff">0</span>].id
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          publicIPAddress<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            id<span style="color:#960050;background-color:#1e0010">:</span> publicIp.id
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource vm <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines@2020-12-01&#39;</span> = {
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> vmName
</span></span><span style="display:flex;"><span>  location<span style="color:#960050;background-color:#1e0010">:</span> location
</span></span><span style="display:flex;"><span>  dependsOn<span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>    nic
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>  properties<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>    hardwareProfile<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>      vmSize<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;Standard_D8s_v5&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    storageProfile<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>      imageReference<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>        publisher<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;MicrosoftWindowsServer&#39;</span>
</span></span><span style="display:flex;"><span>        offer<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;WindowsServer&#39;</span>
</span></span><span style="display:flex;"><span>        sku<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;2019-Datacenter&#39;</span>
</span></span><span style="display:flex;"><span>        version<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;latest&#39;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      osDisk<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>        name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;${vmName}-osdisk&#39;</span>
</span></span><span style="display:flex;"><span>        caching<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;ReadWrite&#39;</span>
</span></span><span style="display:flex;"><span>        createOption<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;FromImage&#39;</span>
</span></span><span style="display:flex;"><span>        diskSizeGB<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    osProfile<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>      computerName<span style="color:#960050;background-color:#1e0010">:</span> vmName
</span></span><span style="display:flex;"><span>      adminUsername<span style="color:#960050;background-color:#1e0010">:</span> adminUsername
</span></span><span style="display:flex;"><span>      adminPassword<span style="color:#960050;background-color:#1e0010">:</span> adminPassword
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    networkProfile<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>      networkInterfaces<span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          id<span style="color:#960050;background-color:#1e0010">:</span> nic.id
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource automationAccount <span style="color:#e6db74">&#39;Microsoft.Automation/automationAccounts@2022-08-08&#39;</span> = {
</span></span><span style="display:flex;"><span>  name<span style="color:#960050;background-color:#1e0010">:</span> automationAccountName
</span></span><span style="display:flex;"><span>  location<span style="color:#960050;background-color:#1e0010">:</span> location
</span></span><span style="display:flex;"><span>  properties<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>    sku<span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>      name<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;Basic&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Die Parameter sollten nach eigenen Vorstellungen angepasst werden, insbesondere  das Kennwort für den administrativen Zugang. Im Azure Portal ist dann folgendes bereitgestellt:</p>
<p>
  <img src="/images/screenshot1.png" alt="Azure Resourcegroup">

</p>
<h3 id="automation-account">Automation Account</h3>
<p>Der Automation Account braucht dann noch eine Berechtigung, um auf der Subscription oder Resourcegroup die VM in der Größe verändern zu können. Dazu ist in diesem Beispiel der Automation Account &ldquo;aa-sizimgdemo&rdquo; mit einer System Assigned Identity und dem entsprechendem Azure Role Assignment versehen worden (vgl. <a href="https://learn.microsoft.com/azure/automation/quickstarts/enable-managed-identity">MS Learn</a>):</p>
<p>
  <img src="/images/screenshot2.png" alt="Azure Automation Account">

</p>
<h3 id="runbook-erstellen-und-mit-einem-schedule-verbinden">Runbook erstellen und mit einem Schedule verbinden</h3>
<p>Das Runbook auf Basis von Powershell zum Verändern der VM-Größe in diesem beschriebenen Szenario würde dann wie folgt aussehen:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Set variables</span>
</span></span><span style="display:flex;"><span>$resourceGroup = <span style="color:#e6db74">&#34;rg-sizingdemo&#34;</span>
</span></span><span style="display:flex;"><span>$vm = <span style="color:#e6db74">&#34;vm-sizingdemo01&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set desired VM-Sizes</span>
</span></span><span style="display:flex;"><span>$normalsize = <span style="color:#e6db74">&#34;Standard_D8s_v5&#34;</span>
</span></span><span style="display:flex;"><span>$smallersize = <span style="color:#e6db74">&#34;Standard_B4s_v2&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># login to Azure</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ensures you do not inherit an AzContext in your runbook</span>
</span></span><span style="display:flex;"><span>Disable-AzContextAutosave -Scope <span style="color:#66d9ef">Process</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Connect to Azure with system-assigned managed identity</span>
</span></span><span style="display:flex;"><span>Connect-AzAccount -Identity
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check if the desired VM size is available</span>
</span></span><span style="display:flex;"><span>$availableSizes = Get-AzVMSize  -ResourceGroupName $resourceGroup -VMName $vm | Select-Object -ExpandProperty Name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>($availableSizes <span style="color:#f92672">-notcontains</span> $normalsize) {
</span></span><span style="display:flex;"><span>    Write-Host <span style="color:#e6db74">&#34;The desired normal VM size is not available.&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>($availableSizes <span style="color:#f92672">-notcontains</span> $smallersize) {
</span></span><span style="display:flex;"><span>    Write-Host <span style="color:#e6db74">&#34;The desired smaller VM size is not available.&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check current Size</span>
</span></span><span style="display:flex;"><span>$updatevm = Get-AzVM -ResourceGroupName $resourceGroup -Name $vm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$actualsize = $updatevm.HardwareProfile.VmSize
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Write-Host <span style="color:#e6db74">&#34;Current Size is </span>$actualsize<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$targetsize = ($actualsize <span style="color:#f92672">-eq</span> $normalsize) ? $smallersize <span style="color:#960050;background-color:#1e0010">:</span> $normalsize
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Deallocate the VM</span>
</span></span><span style="display:flex;"><span>Stop-AzVM -ResourceGroupName $resourceGroup -Name $vm -StayProvisioned -Force 
</span></span><span style="display:flex;"><span>Write-Host <span style="color:#e6db74">&#34;The VM is deallocated.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Write-Host <span style="color:#e6db74">&#34;Target Size is </span>$targetsize<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>$updatevm.HardwareProfile.VmSize = $targetsize
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Resize the VM</span>
</span></span><span style="display:flex;"><span>Update-AzVM -ResourceGroupName $resourceGroup -VM $updatevm
</span></span><span style="display:flex;"><span>Write-Host <span style="color:#e6db74">&#34;New Size is </span>$targetsize<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Start the VM</span>
</span></span><span style="display:flex;"><span>Start-AzVM -ResourceGroupName $resourceGroup -Name $vm
</span></span><span style="display:flex;"><span>Write-Host <span style="color:#e6db74">&#34;The VM is started.&#34;</span>
</span></span></code></pre></div><p><strong>HINWEIS</strong>: Mitlerweile gibt es eine <a href="https://marketplace.visualstudio.com/items?itemName=azure-automation.vscode-azureautomation">Extension</a> für VisualStudio Code um sowohl das Runbook als auch den Schedule und die komplette Konfiguraiton direkt in VSCode zu machen.</p>
<p>Der Schedule wurde auf exemplarisch alle 12 Stunden gestellt:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;/subscriptions/&lt;YOURSUBSCRIPTION&gt;/resourceGroups/rg-sizingdemo/providers/Microsoft.Automation/automationAccounts/aa-sizingdemo/schedules/Resizing&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Resizing&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;Microsoft.Automation/AutomationAccounts/Schedules&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;startTime&#34;</span>: <span style="color:#e6db74">&#34;2023-10-06T16:00:00.000Z&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;startTimeOffsetMinutes&#34;</span>: <span style="color:#ae81ff">120</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;expiryTime&#34;</span>: <span style="color:#e6db74">&#34;9999-12-31T23:59:59.999Z&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;expiryTimeOffsetMinutes&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;isEnabled&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;nextRun&#34;</span>: <span style="color:#e6db74">&#34;2023-10-06T16:00:00.000Z&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;nextRunOffsetMinutes&#34;</span>: <span style="color:#ae81ff">120</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;interval&#34;</span>: <span style="color:#ae81ff">12</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;frequency&#34;</span>: <span style="color:#e6db74">&#34;Hour&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;timeZone&#34;</span>: <span style="color:#e6db74">&#34;Europe/Berlin&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;advancedSchedule&#34;</span>: <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;creationTime&#34;</span>: <span style="color:#e6db74">&#34;2023-10-06T08:45:43.643Z&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;lastModifiedTime&#34;</span>: <span style="color:#e6db74">&#34;2023-10-06T08:45:43.643Z&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>HINWEIS</strong>: Es handelt sich nur um eine exemplarische Umsetzung. Für den produktiven Betireb empfielt sich eine Lösung, die das Resizing z.B. anhand von Tags automatisiert die VMs in der Größe anpasst, damit nicht für jede VM ein Script aufgesetzt werden muss. Beispiele dafür finden sich in der <a href="https://github.com/azureautomation">Runbook Gallery</a> direkt im Azure Portal aufrufbar oder auf Github. Siehe auch <a href="https://aka.ms/AzureAutomationGitHub">aka.ms/AzureAutomationGitHub</a></p>
            
             
            




            
            </div>
            
            

<div class="
    col-lg-3 col-lg-offset-0
    col-md-3 col-md-offset-0
    col-sm-12
    col-xs-12
    sidebar-container
">
    
	
    
    
    
    

    
    
    
</div>

        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    
                    
                    
                    

		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; CAFfeZeit 2025
                    
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow" title="' + t + '">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
